services:
  # Service baru: Caddy (Satpam Depan)
  caddy:
    image: caddy:2-alpine
    container_name: caddy-server
    restart: always
    ports:
      - "80:80" # HTTP
      - "443:443" # HTTPS
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile # Config kita tadi
      - caddy_data:/data # Simpan sertifikat SSL biar gak request ulang terus
      - caddy_config:/config
    depends_on:
      - app
    networks:
      - app-network
  app:
    container_name: sigma-track-backend
    image: rizz404/inventory-api:latest
    depends_on:
      - db
    env_file:
      - .env # Kita akan load variable rahasia dari file .env di server nanti
    environment:
      # Kita override DSN disini agar connect ke container 'db'
      # Format: postgres://user:pass@service_name:port/dbname
      - DSN=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}?sslmode=disable
      - GOOSE_DBSTRING=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}?sslmode=disable
      - ADDR=:5000
      # SMTP Config (dari .env)
      - ENABLE_SMTP=${ENABLE_SMTP}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USERNAME=${SMTP_USERNAME}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_FROM_EMAIL=${SMTP_FROM_EMAIL}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME}
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:5000/livez",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - app-network

  db:
    image: postgres:17-alpine
    container_name: sigma-track-db
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - app-network
    restart: always
    # Optimasi RAM biar kuat di t3.micro (Free Tier)
    command: postgres -c 'shared_buffers=128MB' -c 'max_connections=50'

  migrate:
    image: rizz404/inventory-api:latest
    container_name: migration-job

    # Service ini TIDAK AKAN JALAN kecuali dipanggil manual
    profiles: ["tools"]

    # Perintah: goose up
    command: goose -dir db/migrations up

    depends_on:
      - db
    env_file:
      - .env
    environment:
      - GOOSE_DRIVER=postgres
      - GOOSE_DBSTRING=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}?sslmode=disable
    networks:
      - app-network
    restart: "no"

  seed:
    image: rizz404/inventory-api:latest # Pakai image yang sama
    container_name: execution-seeder

    # MAGIC: Service ini cuma jalan kalau dipanggil manual
    profiles: ["tools"]

    # Perintah: Jalankan binary seeder
    command: ./seeder -type=all -count=10

    # Konek ke DB & Baca Config
    depends_on:
      - db
    env_file:
      - .env
    environment:
      - DSN=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}?sslmode=disable
    networks:
      - app-network
    restart: "no"

volumes:
  postgres_data:
  caddy_data: # Volume baru buat simpan SSL
  caddy_config: # Volume baru buat config

networks:
  app-network:
    driver: bridge
